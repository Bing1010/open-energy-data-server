# SPDX-FileCopyrightText: Vassily Aliseyko, Florian Maurer, Christian Rieke

# SPDX-License-Identifier: AGPL-3.0-or-later

import logging
from io import StringIO

import pandas as pd
import requests
from sqlalchemy import create_engine
from walkthrough_util import create_schema_only, db_uri, set_metadata_only

log = logging.getLogger("opsd")
log.setLevel(logging.INFO)
logging.basicConfig()

metadata_info = {
    "schema_name": "opsd_national_capacity",
    "data_date": "2020-10-01",
    "data_source": "https://data.open-power-system-data.org/national_generation_capacity/2020-10-01/national_generation_capacity_stacked.csv",
    "license": "Attribution required",
    "description": "National generation capacity from opsd. European nation generation by energy source in MW.",
    "contact": "",
    "temporal_start": "1990-01-01",
    "temporal_end": "2020-10-01",
    "concave_hull_geometry": "0103000020E610000001000000450000001F7FF394677E4140E87E8F5E59D04540E1B0E40E1FF4414087A283464AEB444014533593B4F74140F13CF8289DE24440EF093B16EFCA4240BACC346B5F4C42403E12DF505419444042EEB9ECF5673C40661631EE86C04440A918E277914F38408E1A838BB967454010430A032D373440574DD51322464640D92EC52B2F892D40DD2227C61EB64640B82FB532C80C28402C2BCB00840448405065577DD9AC0E4088D985C522994840AABB6CAED5D9C83F7C336F3BE952494020FA12E8B66C11C0A04DFAC950944940D066297228D517C0CB3B13764EA14A4074D36847ED1729C070A682EDB1CD4B40712B752783E733C0A35F236745E94B401549EBECDE1735C090E5122405DA4B40F3425C973C3C35C0A5E68602C4CF4B4098FA2CF1834735C0AD4FA3D24AB24B404CC3172B704F35C0393FCBD9D1A64B405ED8DCB8E84935C07C1E7101738E4B40CD33DE3A282835C076EF112E0EF34840CE7AFC86FAF02DC070C0B25AA9574640038E3C98A49121C0BA0403E27F974540D5B48FCA59031CC0D07A46C74A5E4440645D82827E6610C06A91538744BC4340D084F2A53AC904C089ABE7ECD7684340D61C255D1F33FDBF6462F4B3DF204140562E0D151DB40C40AE6F3174C40F3F409F3517B30C841D403A513FAF21083F40F08715C2B7AC1D405905F21BC0903D40B0CA2E60813C234095AE8E4F0B2739401039760BD13C3040BB95029857DF304005E5A7F17659384094751577A8A23040A33D9B0EBA7E38403499DE9931CD2A40627F21802F553C4021DD614C9E5F2040E3BAC03B6D4241409906D62882E819C0270E315FCE24454068EBAC1769C51FC0E9AD39B2C7B7444003CD74C2B48A20C0054F9ED4C1B1444020710E87491421C05C1BE3109ACA4440263ED0CDB54E2AC0E5E065E605764840823A276574F72AC001EF5CE31FB948409605490A91C431C06FA6E8BB71214C401AECA92DC76136C0F86B6B91DDCC4F40589D6C9C336F36C0F87F9590D5F94F40753DBFDA293636C003F061519F0E50403C62886F6EDB35C0FA5F33A522105040FF51B1BE34E12FC0BF3F9947CE0E4F402226D4E2E06E23C00CC4B90933EF4D4010E9DB1B34F20BC05948DACB97CF4C40DE46899765C43740A015EE4E6A7C504004F9E56837D4374018A48744D782504014649667DAF3374082D1960E388B5040FFC793A2270338405F8A5E7CE38D50407C266BBC4B083F40CDA550DE4E075340B788CC376A46404030DF8D33A70C5440AFF5381D454B4040EF759859A111544042A799848D4B404016F6082BDC115440AA656B7D919240408E3EE6030210544047C7D5C8AE94404042E90B21E70F5440EA211ADD419E404016F6B4C35F0F54404D11E0F42EA44040A4C519C39C0E5440D0D03FC1C5A4404024D5777E510E544078DD79658EB34040138DDD1E4DF4534091130C464A153F400B72D9C6DE645240F7A42B7C29583D40E696331E7539514048148E08D42B3F40C2D740C1E0864940013C2E359C76404002DD283EA7D147401F7FF394677E4140E87E8F5E59D04540",
}


national_generation_capacity_url = "https://data.open-power-system-data.org/national_generation_capacity/2020-10-01/national_generation_capacity_stacked.csv"


def national_generation_capacity(engine):
    log.info("Fetching data from %s", national_generation_capacity_url)
    response = requests.get(national_generation_capacity_url)
    response.raise_for_status()

    log.info("Loading data into DataFrame")
    data = pd.read_csv(StringIO(response.text))

    log.info("Writing data to the database")
    data.to_sql(
        "national_generation_capacity",
        engine,
        if_exists="replace",
    )
    log.info("Data written successfully")


def main(schema_name):
    engine = create_engine(db_uri(schema_name))
    create_schema_only(engine, schema_name)
    national_generation_capacity(engine)
    set_metadata_only(engine, metadata_info)


if __name__ == "__main__":
    main("opsd_national_capacity")
