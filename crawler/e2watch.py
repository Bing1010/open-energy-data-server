# SPDX-FileCopyrightText: Florian Maurer, Jonathan Sejdija
#
# SPDX-License-Identifier: AGPL-3.0-or-later

import json
import logging
import os
from datetime import date, timedelta

import pandas as pd
import requests
from sqlalchemy import text

from common.base_crawler import BaseCrawler

log = logging.getLogger("e2watch")
default_start_date = "2023-01-01 06:00:00"
metadata_info = {
    "schema_name": "e2watch",
    "data_source": "https://stadt-aachen.e2watch.de/",
    "license": "https://www.aachen.de/DE/stadt_buerger/planen_bauen/gebaeudemanagement/SERVICE/2_energieanzeiger/e2watch_Informationen-zum-System.html",
    "description": "Aachen energy. Water, heat and power by building.",
    "contact": "",
    "temporal_start": "2022-01-01 07:00:00",
    "concave_hull_geometry": "0103000020E6100000010000001604000070483DF7A91518408BA9E39EED6249406B76E244451618404B4F9808016349407E53B60496051840A7B6FACDA56449408FA2CCAEB8FF1740855532D072654940910DA48B4DFB1740A0E062450D66494086D6C1CE9C0018403CC594368B6649406C89CCC299011840ED138AA6A2664940B7B6146773021840514D4027A46649400E34C849A8021840A2BF847FA3664940D0C324FFEB371840335BAD41EB644940AB20F170CA371840BEEC5C51F3644940ADC9341E1D3618409E77B4FB2865494084B0AD671A3618408EC87C542965494010A7C68C173618406D8709B429654940502C54E6143618407EDFBD0E2A6549404F8663AA11361840FA8CF27F2A6549403CC75C140F3618409E4687DC2A654940160B6C5C0C361840B7D012402B654940000B26D70936184074087C9E2B6549401D5C13BA07361840480178EF2B654940DBF7E045053618406D97A94F2C65494000F54BB202361840E2CC00B72C65494066D67D4F003618406367EE182D654940A3F4E567FD3518401E3CF1922D6549403D8BCA16FB351840B5478EF62D6549403F00E4A8F8351840CD157C612E654940EB74C769F6351840F1C7BBC62E654940EE7D9CFEDA351840E4F13FB83365494021E7B0E0D63518405E5C487F34654940FDCD95A3D23518408EEE1C5635654940BAFC2BCBCE351840A2A9A12236654940C51EFB37CA35184016D64022376549407F1DE6A6C6351840DDD9E0F3376549408D899D01C335184035DC93D538654940FE8A8EB9BF35184095B4EBAB39654940C52DB311BD351840248946633A654940A0BF3814BA351840FB84F03D3B6549405100AD0DB7351840A7D8D5283C654940404E325CB4351840F8396A073D654940BB73C238B135184095BE571C3E654940A39A8ED4AE351840E9EB6CFE3E654940FFE47C72AC3518404100C7F03F6549404658B25CAA35184099B6F1D540654940EFC041A465351840FBD8EDE4606549407A7FE65B643518408258A51A61654940F59AAD90613518407AA7C79261654940BE925EFC5E351840C4CEAD0462654940759E28DB5B351840A26BA39262654940F8782D5E59351840BC369806636549408B0D9FC456351840A1C41B83636549405FBF605F5435184061180CF9636549407EB171264D32184049A1FA48FD65494084FFE36F4B321840F31FB945FD6549405B992A684532184099956D3DFD654940E1F63ABD3F321840F8539A38FD654940A761D4ED3A32184067F70637FD654940924968423532184056842338FD65494006F0A5392F32184041627B3CFD6549401D454B8F29321840C06F8743FD654940BFB7CE91223218404D65E44FFD6549400F0F13EA1C321840CD04DE5CFD654940282CE5E6163218401E88D46DFD6549408263554311321840142BB880FD654940A97EBAC90B321840D484F695FD654940FC50E22B06321840A3FDBEAEFD654940A130E03400321840F58D41CCFD654940BCC5499EFA3118406811E8EAFD654940F9222732F9311840A01D7AF3FD65494012CC24C1F731184009C2ACF7FD654940D085031EF23118403494120BFE654940C608A120EC31184028A2DC22FE6549409C605983E6311840A4C4263CFE654940DF2BAB10E131184069869B57FE654940C823C77ADB3118406F0AC376FE65494008981F8DD5311840ED46099BFE6549406C2A2700D031184024A205C0FE6549405E68C82BC9311840AA0A46F1FE6549405E1C41A9C331184088190D1CFF654940A734D4D1BD311840B5C0A74CFF654940ACB6405BB83118402CC92D7DFF654940A0E831BEB3311840F4FAC4A8FF6549407A9D1155AE311840BDAFFCDEFF654940FCAE469AA83118409179B61B00664940E1491540A3311840E2FD905700664940B47B19AE9C3118404731ECA400664940CD9A4E6497311840B11C59E6006649406D976DCC913118406477EF2E01664940BA597C948C31184070DADC75016649403F781CEAD230184012F2E3C40B6649407514F9243730184033FD119A136649406C9B36A8223018407C453BD514664940798BDE9F0D3018408CA30751166649400C73539AFA2F1840EA764EDF17664940AF976E66E42F18401C45E4F519664940B4BBEC2BD32F1840779D6DD01B664940E84BD8F0C12F1840AC4DEAED1D664940AAC44ACDB22F18401C1A8B0C20664940B3EC36A9842F1840AAD0A26E276649409683EB3A842F18404FC55B80276649406EACCBC5832F184028DA419327664940777B1358832F1840761009A527664940C21ADDD0822F1840454709BB276649403598B863822F184014ACDECC27664940823AD3EF812F184087F3E2DF27664940AEDD4283812F18405673C6F12766494062596E2E852E18407BF1A0B2516649400B499CA57E2E1840D6F41FDB52664940C16D0D05782E18400E15BF1D54664940AF9EF21A722E1840B3A048535566494059E1F5356B2E1840FF2B27D856664940E8220EF1652E1840D1EC6719586649400961E5AF602E184083B8F274596649408E69F7155C2E18409B838AC05A664940DDF68484502E1840BB83A3515E664940C20E9C9A4C2E18407AD826A65F664940FD81DDCF482E184001FFAA146166494075FC439A452E18407295A4706266494002D39716422E184003055D2164664940DC59D2983F2E184020674F8365664940D0171A553D2E1840837B87FE6666494029D0E3913B2E18405BA7EE6468664940E2D4CE0E082E184027830D539C664940CE54EE13072E18402DD8C9A39D664940DB8B8160062E184071B3FE0A9F6649402FE8560A062E18407820045DA0664940882BD605062E184088B9EAFDA16649400977B354062E1840D047F74FA3664940DCA95D00072E1840284E3BB7A466494052C6F7F3072E184026000D08A66649400A9F5E0D372E184085AD1496D66649404AF90F4F2F2E184095377097D9664940E56AE039282E1840660D87D6E266494072DF74F6552E1840399DF4FC11674940E9A5B8BC562E1840EDA2AFB01267494036ADF5AB572E1840829B1D7213674940C1C829A1582E1840DA68F024146749400550EFDA592E1840C4563DF514674940E088D0FE5A2E18405CE6F6A6156749409D79BF525C2E1840A72506661667494052CCFDA45D2E18402DBF751617674940984485795F2E1840B43656FA176749400EF8C3F9602E1840507C4BA918674940EF2CF0B0622E184042902A6519674940C0EBC55E642E1840CF8B75121A67494030A75E6F662E18403CB3DBDB1A674940929C554A682E184072E34C871B67494041A6DD626A2E1840B6D82D3F1C674940629E736A6C2E1840363E96E81C67494061554FA9772E1840CF622667206749406A7253F8772E18403817E02221674940863E9DB8792E18402DD217532367494070A4021C7C2E18401641DF57256749404CA171C47F2E1840A9F3CFAB27674940132A3AAA832E184079C71AA729674940EDB771AA882E1840117DE5C22B67494091BCC1098E2E1840BBCA32B02D6749408FD52C3C022F1840666176CB516749401661D36F042F1840888BA772526749400B166BE7062F18404ACFC025536749407BB18746092F1840F5E88CCA536749400341E8240C2F1840451D9A8954674940677ED4AE0E2F184051F9D32B55674940567FC782112F18401F3661D955674940EF34D136142F1840FE5BDC78566749404B6936D3172F1840429AD04557674940A2E19FB01A2F1840F75161E2576749401591D4DD1D2F18402447A48958674940A4BED4E3202F18403AA51F235967494073646C83242F1840D50C8FD459674940151A2FB1272F18405FFECA6A5A674940DE012A342B2F184070500C0B5B674940FE2BD0882E2F184064A6DF9D5B67494076227F69342F184068BF41985C674940DD031FE4372F1840D93984275D67494057A606B93B2F1840873B14C05D674940FB18AC583F2F1840D1949E4B5E6749405FC39BA9432F1840B1FA66EC5E674940C97B486D472F18404CF212745F674940B58CE98F4B2F184035654A04606749402C5E95764F2F1840F5C9F28760674940CB53D99B542F1840302F033061674940F27972A4582F1840A9E983AF616749406F7844105D2F184083B5C4366267494028E2AF39612F1840E0D1FAB162674940E6B00F29662F1840F8F15B3F636749406E4D29726A2F184089A925B6636749402B7D53226F2F18409589DB33646749406A8DEE89732F18402C4C18A664674940CB68ABFCC62F184086ADE4D26C67494006C0C6EE72271840049B18BE77694940C9910862682718400239FBEF7A694940C2564BEF09261840CC455DF3026A4940C9E88024EC2B184099620E828E6A4940469EE71E2F3218409D37CB07526A49406FAB3ABE763318408B5C79AB456A4940F8FE5F3676331840C4B34BF3446A4940B98D65F360331840099D1C083B6A49403AA32C9AD2331840616E8156346A4940DE8CE473D333184001939749346A494037717E5ED4331840B859943B346A494051DBA537D53318407BB0842E346A4940B568843DD6331840DE71A81E346A4940C8A71916D73318407A147311346A4940F12978FFD7331840AE7E1E03346A4940EAA079D7D83318405686C3F5336A4940679F6FC6D93318409D53E3E6336A494022AADB9DDA3318404ADA62D9336A494072BDF785DB331840CE56BDCA336A4940CFB9CC5CDC331840B57617BD336A4940B096D95FDD331840221486AC336A4940CDE81536DE3318406EE7BA9E336A4940588CE81CDF33184065E7C48F336A4940E8968AF2DF331840B288D481336A4940F7EADB60EB461840204B1D4AF368494053AE373FC94718409DAB7FB8FA684940F4392BBFCE4718408C3895E4FA684940F8F415B4D4471840422A0711FB6849401B8CD23EDA4718407F885437FB684940E89FA6F4E0471840EED80A62FB6849403655A788E647184078888582FB684940FC748F91EC4718400B9E67A2FB684940E2D34C2DF24718409AB706BDFB684940823A1AF3F347184030887EC4FB6849408B13D1220F4818406848FFF1FB68494057D55C682C481840C99346D9FB68494069BF2F7B47481840AE83F27DFB6849402DA6BB4D67481840BB55C7C0FA6849407A218F9881481840A2A9DFDEF9684940334B32319D481840E52F8BA5F8684940A1D8DA0DB6481840C6A5A342F768494003A54B6F1F4918404D4A1718F068494034F3E9C0F04A1840C6F64582E0684940577B4234024B18403B0C72CCDF6849400CDBBEA7144B18400F15F3E8DE684940564A2B68254B1840E85A13F9DD684940EB2BDCA9024C18400E7E28CBCF68494043D8238F144C184019DAB878CE6849408D2A5E1D274C1840489EE2E7CC684940E7906D9D374C18402EA64D53CB684940B7725A66044F184072088EB67D684940B6CCF9CF254F18404418FED578684940ED4817E6424F18407BC5580773684940CBF71567574F18400BB429246D684940AA99DB8B784F1840377FF6AD5D684940387E3C567E4F1840479003A55C68494033AD2289884F184035289CA95A684940CB16B6598F4F1840C7F0D837596849405411B935964F1840EF1564A057684940782F351C9C4F1840EC6DDD1E56684940551E52A4A24F184097CBA1465468494066DCA897A74F1840BC59A7B752684940C3C7C667AC4F1840635536035168494089365F60B04F18407D652C694F684940E79CA787465018405DFD005D09684940E464124EBA6218401015BF315B664940E4D44B1CC06218403E4952A45A664940DF387045C66218406A7F94075A6649401DD1B5E2CB62184099727572596649404AAC7DB727661840B3699258FC654940772D86CD456618400A878A5AFD6549409AC7E3C9496618402F5F197BFD6549400B7FFC194E661840CEBD969CFD654940B8773F1C5266184095111CBAFD654940A7EC102916671840DB99990F03664940714CD3BE27671840CBCF106C0366494084151CD43A671840566D62B003664940A2520A9E4C67184045238FD203664940943ABC9906711840B277E9780666494093CC4F580C721840F2E9BB3027664940051D8BE71C7218405DBB1603296649405DB99FB22F721840B0CFE5D32A664940357188F941721840E4D1245F2C66494026F957CD537218404473D9AD2D664940EA37168067721840468394EB2E664940A00B19597D721840A52ACC15306649406527EF25927218401ACFDC0031664940A1684BD81A7618403998B60151664940CFAC063327761840CC35136251664940C87E56A134761840CDF642BA516649402F57172C41761840D0465EFD516649405DF39A114D761840F22ABD2E5266494058F515BB5976184042A43A5452664940B4319D6B67761840FCB0976C5266494081935C227476184050A1437452664940A0B5FEBFE47B1840CEBFB4584F664940C6EDDFE4017C1840D342D9DA5466494071255874087C1840B9C5C10256664940CBE5FAD90F7C18402BA8463A57664940852EAE00177C18409E03D25358664940315F92051E7C1840C1C8655659664940ECD9A9BB257C18407A595F605A66494015DE63562E7C1840B08F54765B6649407A7B6B93367C1840D1C3986F5C6649404B50451A407C18403497827D5D664940641435D5487C1840CB2D00655E664940EEE8557F527C1840C032A4545F6649400FD19BAE5B7C184053675D2960664940558DAB8D647C18407960FFE860664940BE0F36276E7C18405F010BAA61664940827368B6787C18409026446F626649407488B1AF827C18408194CE1B636649400327ABEE137E1840596368237C66494013D0C33C1E7E18404679B4BA7C664940F422C782297E184098DC22527D6649400369631A347E18402ABF8AD37D66494011CED9383E7E18400FB42B437E66494038245D0E497E1840798721AE7E664940F1FECFD9547E184032DB2D157F6649402EFC59E15F7E1840A65E3C697F6649407FA31C596C7E18404A3A8FBA7F664940C6069686777E18407F485AF77F6649405F87CEA3837E1840AF2C412C806649402E7AF6EA8E7E1840F020865180664940F9614A98997E1840A6988A6980664940D7E6C3ECA47E1840DB972077806649400FFDB126B17E18408553FA7880664940C07C117CBC7E1840FF78D26E8066494012A3B6177C8018401B0308087D664940C8898F6187801840E5702DE67C6649408864A58293801840FBE8F1B47C664940D3C197B49E801840A5BB897B7C664940A2998336A980184027B44E3A7C6649404BB04944B480184016DA97E97B6649405F526617C0801840F4B41E867B664940150BE2F4CA80184073A9711E7B66494006BD5206D7801840EC27639D7A6649402FF29AA7E18018401A92311F7A6649402CE8F2F8EC801840FC862E8B79664940CD726052F780184033BD02F778664940C8EC93F1008118406039FA60786649407069CEF70A811840ACA976B77766494099AACE9515811840160C72F576664940EFEAD83D1F811840128A5037766649405AF6D9B9CA81184085DF1B0A686649401DD37529F18118409B6F81E077664940EC977BE5F2811840C6193D8D78664940A113D2DCF48118405D019446796649409099D1C5F68118400B1967F1796649405ACD77A9F8811840BC1E06927A664940CB07EBBEFA811840E8CFC13A7B664940E3082716FD8118408DB195EF7B664940B7BB7B57FF811840F7BA0B967C6649407FA77AFD0182184034B415517D664940F68E126A04821840FF7318F57D6649403F2FA31E078218401815A3A47E664940772BD4B509821840599505467F664940EDFF0F3D0C821840C0B360DD7F6649409A4324FE0E821840DAB6F67B80664940B64C120D1282184037A8772581664940728F48F71482184010B515C181664940A3BE72C6018318403594F15AB1664940DBF4071308831840A4039C88B2664940B8C833320F8318409DFEA0C6B3664940EBEA2B19168318406F1B77E6B4664940434C7CE31C83184083AA39EFB5664940BF58465D24831840BAEBFFFFB6664940016EEDB82C831840954F8D1DB86649407A7057BD348318401EAF181EB9664940039AD3063E83184088E36E34BA6649406AA6138D46831840EF25A623BB664940C6D0990050831840AE29D91BBC664940C9A657FF588318408D12B6F8BC6649403FCB9FB2618318406D0D36C0BD6649406B14FF1F6B831840D97EC689BE6649409540FE8175831840E9F65F58BF6649400F60A9537F831840E6FAC60DC0664940BAE879063F841840A43A8BDCCC66494021B4C2DD54841840678E1A16CE66494083F72A0C6D841840E865D532CF664940252DD607848418409B691109D0664940D46DC0BB6E8518404360C66BD66649404D94B3DF83851840AD52C8D3D6664940CAC9F1CF9A851840345C9B16D7664940185F2D31B08518407E29782AD7664940BFCEDD627087184071ACBF54D5664940E54AFDC07487184079B2674ED56649401A3A7F767987184093C1A845D566494018C4FBD27D871840517BCA3BD566494019FEFE3F0D881840A3BB01BDD36649400F96925035881840C95A20B7D2664940C2EED7E75E881840365769FED066494064BCC2EF83881840606E5AD3CE664940E61595F3938918400C7B63AEB96649404C91E8609D89184047D4D0E4B866494010691051A7891840CC59EB00B8664940AE4FC14FB089184085550C24B766494046C8D595B88918405B49C24AB66649403BD2071CC1891840C507895BB56649400AF17208CA8918401D251450B46649400DEDCD0CD2891840D6E4864FB36649405F907FBFDA891840A55F5726B266494046A33939E2891840245E8F15B166494028C1D1FAE9891840DE981EE7AF6649403F08B9E1F08918401BDE46C7AE66494049DFB81DF78918408CD9DDB0AD664940F26A3C6AFD8918405AF03183AC664940932B08DF038A1840CE0AF236AB664940754B408A098A1840E0A6BCFCA96649403F38A68BAD8A18407C3DC1A18366494099B4898E289318407FC6E568A96649401B9D314F21961840ADA037B58C664940ED444948A49D1840E3FC4D2844664940AB4BD3AC7BA21840E65E226B9F654940549FFE7B68A21840B07B447796654940C55F123268A21840DB3E3755966549406EA99CDF67A21840D04BB42F96654940A600F59367A21840EB49B60D96654940A4ED5D4B67A21840D0857EED9565494083A4FBFD66A218401A1990CB9565494053E3B5A766A218408B822FA695654940CBC6995866A21840E4045184956549408641D73457A218408CD8681C8F654940C3F171D24FA21840E8771A948C654940A48C125346A21840F23E40DC89654940970D167B3CA21840354251768765494066E0032132A21840C6D30F49856549409C8178FA25A21840489D020F83654940974FE16917A21840A9768CB7806549409C12F52409A21840536835B27E65494094764E0770A01840D294808E4B654940E20CD9644CA0184024441B3BB96449404309226F5AA018405966EF7BB7644940A188E06A69A018408604CD5BB56449400976F56776A01840D983C540B36449404E89B20A83A018404891B5E6B06449400418618F8FA018409495A334AE644940B0BC45E890A01840EB0ABCDDAD6449402BCFEED292A018408A176A92AE64494061D8B75D9CA0184087109773B1644940B3A6D663A6A01840A08909FEB3644940E6E67F06B1A018402ABC824BB6644940E89BDE9DBDA01840656286A6B86449405DA1C7CBCCA0184097528D1FBB64494025223FBDDBA0184075CED040BD64494022E3D7EB55A3184095E6A3860C65494035C2F3F566A31840B1D6D2640E654940C7432BBE7AA318405FF78F4A10654940807548968DA31840FDCD7BDD11654940CB091202A0A3184003F6D031136549407BD2A555B4A31840CCCF9472146549405D9A0D5FCBA31840F3F0EDA315654940481B0FD5E0A3184083C70C8D16654940F2A78E04FAA518404769148B28654940DCA0F65B3BB11840F722DA8EA96349404980B3EB72B318404DA293FDE36249401E956ADCEAB31840FC2C4D3DBA6249403769FD3CDBB318405573C43DB9624940957A8139B9B3184062C7279BB7624940F8286ED698B1184043A0605FA56249400507BECB8DB118401CB5FD0CA56249402916B38A81B11840FCD0FDBEA46249409E02F55A76B11840E407E483A46249401609E86865B118401E58803CA4624940E7565F205AB11840D17AF018A46249401739B8A84DB118402556CAFEA36249402E68C35342B118409460EBF2A36249408AD9296434B118409460EBF2A3624940A208350F29B118402556CAFEA3624940D1EA8D971CB11840D17AF018A46249409F38054F11B118401E58803CA4624940183FF85C00B11840E407E483A4624940892B3A2DF5B01840FCD0FDBEA4624940AF3A2FECE8B018401CB5FD0CA5624940C3187FE1DDB0184043A0605FA5624940570275927BAD1840F1CA6E63C2624940A386EDB870AD18409C87C0CCC2624940E7BB2BE464AD18403583444DC3624940D2B6B1475AAD1840199D11CDC36249408D45467D4AAD184037375F9EC46249402C9A7B2940AD1840CD941B34C5624940069DD5F434AD18405ABAF0E4C5624940967F0CF52AAD18408E36F88FC662494038AF6AE31EAD184078CFF16EC76249405F3E994215AD18406DED882EC8624940946624DF0AAD18409FABA80CC962494089A5D8A701AD18404C64FDDFC96249406DB28A18F4AC18405F69F12CCB62494025F6DE54EBAC1840E8111C13CC6249405E4C1CF0E1AC18406574B91ACD624940BD29ACA9D9AC1840F3BBBD12CE624940EEEA82859DAC1840CDE34297D562494071221BDD45AA184015D9687EA16049403DE1AB5D51AA1840D6632D3F9F60494010E3D0DF52AA18406B8D5DF29E604940CBCCFE8354AA184035D53E9D9E6049405BB308FC55AA18408E73A74F9E6049404636A32C58AA184062ADD0D99D604940903B789A59AA1840E811778B9D60494075C624285BAA1840C315AC349D604940E3D6AB8B5CAA18405B9F95E59C6049406A07DD3E5EAA1840CCA9E4829C604940CAC5FD975FAA1840F0C316339C604940F9EDBB0E61AA1840CC4EB7DA9B6049403AB35E5D62AA18409771378A9B604940B9EC1D4F64AA1840BEF80B109B6049409DC82B9365AA1840D0A8DFBE9A6049403FD394F266AA184089F403659A6049403090F72B68AA184014C230139A6049401DEE7BBF69AA1840919D94A7996049400A121EEE6AAA184022242055996049404BAAD1356CAA1840AFD2E0F998604940F4769E596DAA184016B9D0A698604940A7C1600A6FAA1840BB7AD628986049408937442370AA1840487230D5976049401588E85271AA18402E87A678976049409866CF6072AA18409C4B702497604940D08E39A973AA184013C17DBB96604940435611AC74AA1840F717BD66966049400E2253C375AA18406CF101099660494054150ABB76AA1840ABA9BCB395604940C209F52878AA18408EBF7D3295604940462E7A1579AA18405DB1B9DC94604940F9E70C147AAA18401D01E77D94604940F40750F57AAA1840450DAA2794604940CE97447CAFAA184062BC4B797F604940DA0B960342B3184085E1D2A7345F4940252F7E9442B31840F172DD91345F4940FBA1C33343B31840395B9A79345F4940C062C4C343B3184066318D63345F4940D11BBE9C44B31840CAAA2642345F4940E385D62B45B318401CEB012C345F4940E49E1BC945B31840D2D18A13345F494037B84A5746B31840FAA24EFD335F4940E8B4ECE1E8C61840996886C61D5C49400BB5A679C7C918403E3F8C101E5B4940688542E118C11840679E5033D15A4940911C30C81DBD1840DE616275E95A49401C25AEFE15BD1840B6D33F64DD5A4940AFF6E1B30EBD184066E2C0AFD85A4940EA83B3C400BD1840C9829919D35A4940599452B1F8BC1840BC9D07CCD05A49401314BD74FCBC1840580E970ACF5A49400D6AF7A501BD184030CF8765CB5A49409CDB25EE04BD184085F133E2C65A494006D9AB1405BD18408F2C7A2EC35A4940A869E281F6BC18402C264299AC5A4940DD642F80D7BB1840ABC14FACA25A4940952710768AB51840E7A8A3E36A5A49409A96429A82AA18405C44D633AE5A4940EECB583A6EA21840BB9C051C385B4940441E86776BA21840360C5904385B49407F57A47D54A218405DD31C25355B4940D03434374CA21840CE8B182D345B49401A7DA6BF41A2184091925B07335B4940F9C0FAFB38A218400BEA3021325B4940AFF7A54C2EA21840EA52D41A315B494093365A1525A218403B9A7F47305B494034A1FF8119A21840CF02FE4F2F5B49406C302EE10FA21840DCE466902E5B49403371950E05A21840E58A73C82D5B4940F753CC0EFBA11840B40E6C1D2D5B4940C40D5992EEA1184089FB61582C5B49403F628E3EE4A11840F09DA5C22B5B49400F0F32CDD7A11840BD30B81D2B5B4940E109B830CDA11840D816EB9D2A5B49408F43DD01C0A11840DB9BB70E2A5B4940CCC75528B5A118402FDF65A5295B494060B14BD9529E184081B457A10C5B4940D38F9BCE479E18405DC9F44E0C5B4940DEED17273A9E18408C270BF80B5B494007DA59F72E9E1840715EF1BC0B5B49406CB7099D219E1840356DB0840B5B4940F9048154169E1840E88F20610B5B494062B02370089E1840CC79FD430B5B4940A4DF2E1BFD9D18403B841E380B5B4940634CA38DF39D18403B841E380B5B49409D454519E79D1840C14A76460B5B494033A34ED6D79D1840439BA8690B5B4940349E6F72CB9D18408FEF9C940B5B4940C169DFCDBC9D18401E3A81D80B5B49408F8EE88AB09D18408037D91F0C5B49408F4FB298A19D1840F8EDB5880C5B49404D31E186959D1840B21513EC0C5B49406BDEC785369A1840350C5BDA2C5B4940CE89A949229A18409333B4C62D5B494064334B160A9A1840D2FB4D192F5B49404227D3ECF699184004292C54305B4940A11C6216E199184004D4D2F3315B4940DDAE624BCF99184058225878335B49408C96D671BA991840DD29387F355B49404C57B74BAA9918403B456347375B49404F961E1D309718405B5D368D865B49407C15A72B219718403BD979AE885B49402890B24110971840E0E2D66F8B5B49402FDB53AA039718401A89DACA8D5B494094B80350F6961840AAACF0AE905B49404DEAE449EC961840C0256339935B49401479F8A7E19618404EE7CC6E965B494092C4015FDA9618406A178D1D995B4940730D8FA7AE96184022C96E82AD5B49400EEC7938DA951840EBAC8EB8B35B49406350D335A195184076D93998AC5B49407038272D959518402DEBB839AB5B494071341FCB859518408AC83FA2A95B494026C1FAC878951840C0E26A69A85B49400C5D95D968951840BE966E0EA75B4940BF30B3885D9518408C722930A65B4940AC1C6D3D57951840ECDF877FA55B49402960C1794E9518405D375D99A45B4940D2966CCA439518403CA00093A35B4940A5D520933A9518408DE7ABBFA25B49405940C6FF2E95184024502AC8A15B4940C2CFF45E2595184035329308A15B4940C0B133C41B95184042322157A05B4940B4946AC41195184015B619AC9F5B4940914EF74705951840EBA20FE79E5B4940F5A22CF4FA941840504553519E5B4940D34FD082EE9418401ED865AC9D5B49409D4A56E6E394184039BE982C9D5B49405A847BB7D69418403D43659D9C5B4940B708F4DDCB941840938613349C5B494001507FCDE291184072C99D3F835B494079C3C7FEE09118404753E0EF825B49409DFC980ADA9118407E9B50D1815B4940F7F3C625D19118408A03937A805B49400648789FC9911840FF1B2E6B7F5B494093E81A5CC0911840E86E54327E5B49404D05EC4BB891184060DA43337D5B4940BCE0AF14AE911840BCCF9A047C5B49405D987783A5911840572AF6167B5B49403A4972E69C911840A31D68377A5B4940C9E294DD9391184074EA335C795B494094F7AD8088911840FC25CD5A785B494024E2120A7F91184050B1F992775B4940BC07BD8F739118403F2581B1765B49401900C4B569911840547DE9FD755B494006F8F7645D91184056792C2E755B49403FA86D32539118401A7E958F745B49402E7092ACB98F1840A2DCBBB85D5B49409E99A42CAF8F1840F267D32F5D5B4940206FE51DA28F18408D154E955C5B494025AA165C978F1840AB3CAA225C5B4940497606738A8F1840F260F0A75B5B49409491217B7F8F1840DCCF0E4C5B5B49409445A1E7718F1840450566E95A5B4940435BACC5668F18401175ABA45A5B49404A8AD9D15B8F1840BD1CE16C5A5B4940B1D00892508F184021E5983F5A5B49405EE23EB5428F1840EBC87C165A5B49408D4AE763378F1840A78DD8005A5B4940CACB58ED298F184080753AF5595B494086BB45BF228F18403C918DF6595B49400B203923198F184077A5EC7A555B4940A240DABCBD8D18400010E2C25D5B4940AF264F594D8718404B5AF10D855B49406163A546FA7F1840E2460691CA5B49409480D3873F80184020F5B9B2FC5B4940EF2E6B70508018409590AEFA025C49400472540F6E801840E2BC661F0A5C49408A6F235F8D801840AE2976780F5C49400C6E72C9008318407F09C0E55D5C49402A46A30004831840DD36044A5E5C494093CA920008831840C6828AC35E5C49408E8D454C0B8318400D861B255F5C49403C0BB3440F8318403C27A1975F5C4940A6B156A412831840F63A6EF65F5C4940496A43D5168318405C562969605C49409F7E43481A831840B22E22C5605C4940447FEA1543831840FD1CC7E8645C49400055F2C85183184063B2323F665C494086A1A97B64831840E3A571C4675C494010650A397483184072B3AFE7685C4940DB034E6187831840961674206A5C4940B8ACA8FC9783184027954F0D6B5C4940BF7C4BCFAC83184029594B0D6C5C49402B3FCF19BE831840019228C16C5C49405755A20FF28618400BF2CD37885C4940E676521AFD8618402FDD308A885C4940DC18D6C10A871840007F1AE1885C4940B12C94F1158718401B48341C895C49404C4FE44B2387184057397554895C4940BF016D942E871840A4160578895C49405656CA783C871840C02C2895895C49401427BFCD47871840512207A1895C49404A26DFE452871840512207A1895C494008F7D3395E871840C02C2895895C49409F4B311E6C871840A4160578895C494012FEB9667787184057397554895C4940AD200AC1848718401B48341C895C49408234C8F08F871840007F1AE1885C494078D64B989D8718402FDD308A885C494008F8FBA2A88718400BF2CD37885C4940F3BAEAD4EB8818402CF49B647D5C4940323E9FF4EA881840FFAE45817E5C49404D8D860BEA8818409459D13D805C4940C0E08EACE9881840B2F36FA8815C4940C0E08EACE988184098F3530B835C49404D8D860BEA881840B68DF275845C4940323E9FF4EA8818404B387E32865C49409F281E11EC881840974E8F9B875C494081B225D3ED881840EA52D946895C494047FBF3ABEF8818405B15D1AC8A5C4940C7094163F28818409789C1618C5C4940F26258F6F4881840CF8D17C38D5C4940859108881B891840A8F23AC19F5C494060B8C916DD8918409DD0F80CFA5C4940BB9D5761E089184013C02968FB5C49409975F3DAE4891840DA18050EFD5C4940B5445CD9E88918407D599461FE5C494043AEC700EE891840E1E3BFEFFF5C49401A9BAAAEF28918405639393A015D49406C34FBD6F88918401BA2C7C9025D4940D715372FFE891840BCC5C009045D49407215C7BA038A18407DE9183D055D4940F90480B7098A184093173371065D494051C08C73118A18403F6A9EE3075D4940D785320E188A184067E2870A095D4940E43E1741208A1840927B72600A5D494029836C72278A18401AF3E7780B5D49402D4D54A0308A184015AAD9C70C5D4940B6897660388A18406CAEA7D00D5D4940A00986ED208C18406A9E49E24A5D494083E1B624248C1840C1CB8D464B5D49409465A624288C1840A01714C04B5D49403B2859702B8C1840DE1AA5214C5D4940E9A5C6682F8C18400EBC2A944C5D49409C4C6AC8328C1840D1CFF7F24C5D4940980557F9368C184041EBB2654D5D4940351A576C3A8C18409EC3ABC14D5D4940E5783134DB8C18400CC812115E5D49409C4E39E7E98C1840725D7E675F5D4940219BF099FC8C1840F250BDEC605D4940AF5E51570C8D1840815EFB0F625D49407AFD947F1F8D1840A5C1BF48635D49405AA6EF1A308D184036409B35645D4940627692ED448D184038049735655D4940CB381638568D1840103D74E9655D49405B6D997E048F184051F2CB52745D494054878AB5E88518402F47811E605F494061155FF2E48518407F8FEE0D605F49402E3473AACF851840B3D1DAD25F5F494098E7B244BE8518408E9BA6BE5F5F4940FEE6C309576918408BD2D2746C5F4940026942807F6818400CA82AE8075F494078B44B3778681840ED776A39055F494038435F956D6818405EB60004025F4940EF74408F63681840483D8E79FF5E49409A5321D655681840A246F180FC5E4940AE9EC23E496818406CA0ED25FA5E49406119CE5438681840C8969064F75E49408B98566329681840E71A4D43F55E49408ED7BD34AF651840C7027AFDA55E494073F8A12A9E651840AA124B1FA45E494049ABB91F8865184000820C02A25E49408B799C477565184062AB206FA05E49405AC4B4825D65184038C7FCB79E5E4940B4FB202F4965184070ED38779D5E494047EFD2832F651840495FFB229C5E4940626ED10D1A651840B988DC399B5E49402F652DAD63641840C3A8161E955E4940B88E5F645D641840BA3636EC945E4940F01B65A355641840687E92B3945E4940E842CE4C4F6418403E803E89945E49405A1449A59561184081F4DA07845E49408836CB47886118409AE911C8835E4940910041CA7761184046AC4C8E835E4940F68E664F6A61184023F60970835E4940A2DF131B9C3A1840ABA81EE45C5E49401A2A2AF845371840AC5C2A8E7C5E4940E2CCAFE6003118409CA6CF0EB85E494011B23F7FD12B1840BA6EE6506D5F494005B7CCADE52B184003BCA01D735F4940EFBAE659F52B1840768ED5AA765F49400B4B1CB6082C1840EDC998387A5F4940815C13681D2C1840DF1359587D5F49402A408818B72C184054B0678E905F4940BD62F85EBF2C1840E0F76B86915F494098FC2271C82C1840547FFB84925F4940E4B8CE34D12C1840DE27266B935F4940E4711C4DD92C18408D75EA31945F494022336884E22C18403F2E3F05955F4940378B858CEC2C184019E1BDDB955F4940C5FB562DF62C184007FF549B965F49403D302866002D1840713D2F58975F4940814DF1650A2D1840A3B93603985F49407F741038152D1840580EF9AD985F49404E20DB8B1F2D1840F56BB543995F49407FC81AF9282D1840D0A1A8C0995F4940A9CD9495332D1840B4BB75409A5F494043FD4F023F2D184060BB8FBC9A5F4940C278D7DB492D18400978E1259B5F49402E8FE12AAC301840B7A2EF29B85F4940B4B09135B7301840DB8D527CB85F4940CDE9DD0AC330184096A0A4C7B85F49408CFD9B3ACE301840B069BE02B95F4940E0195858D830184095A75C2DB95F494051CCE0A0E3301840E384EC50B95F4940B508E9AAEF301840BBBE2C6AB95F494094D9DDFFFA3018404CB40B76B95F494030C081CD063118404CB40B76B95F49400F91762212311840BBBE2C6AB95F494073CD7E2C1E311840E384EC50B95F4940E47F07752931184095A75C2DB95F4940389CC39233311840B069BE02B95F4940FCAF81C23E31184096A0A4C7B85F494013E9CD974A311840DB8D527CB85F4940910A7EA255311840B7A2EF29B85F4940CD37D3F7ED311840E8E9C50FB35F494019B5D917F63518407BE3E136E361494066BAB270DD351840883213B7EE614940A9903BCEDA351840DB67A90DEF61494056DBD3EAD6351840E496B491EF6149405B37B4D9D2351840E5FB6B20F06149408F046519CF351840CA4477A8F0614940C3BC03ADC9351840B67FC373F1614940B14CD410C63518403697A9FFF1614940778C9B4CC23518404FBA9596F2614940AF3789D5BE351840BC463026F36149408D5CADC6BB351840FB3E4DA9F36149400C50AB75B835184083E2743CF4614940FC757A02B53518409651F0DAF46149401E6F71D8B13518403CB57C71F56149408009CD9AAE3518402E974311F6614940B4169B98AB351840CD750BABF66149406D513A7AA835184022756850F76149409B94B2A0A5351840DDA641EDF761494031237221A3351840D257057CF86149403E995C71A035184063DDC41BF96149406E1D37AB9D3518404A264EC7F961494076E6F96B9D3518400B8E36D7F96149408F18C7648B351840309CD0C2FC61494054766D297835184085134BAC006249406A039403643518400908D8F4056249409EE5C8FA23351840E3F84BAF106249401ADAFAA920351840594C784211624940ED0102371D351840A29BF8E011624940482F2E0D1A35184012788977126249405EF7C3041635184021A8703E13624940AB5CC8021335184050C73CD8136249406E07A2E40F351840042F9E7D146249406DB8510B0D351840CA677B1A1562494052E013520A351840E6AB42B61562494096CA36A207351840E2FD05561662494052ED4DDC0435184066329301176249406AA1A05602351840D5D110A4176249404BD2BD26FF341840E09D1C7A186249405F50F1CBFC34184085FF271F19624940BA245061FA3418406DF124D01962494088AB0932F8341840ECD690771A62494025F95745F634184089DA1E121B62494064D93042F43418409D5EBDBB1B62494096887D35F2341840D60868711C6249409EFA025FF0341840FBAB0A1D1D6249402A599D15EE341840C18191FE1D624940C455506CEC3418401B3709AC1E6249402C11CABFEA34184099739A651F624940152F1F44E93418408FADB714206249407B7A2FE5E7341840B2CABEC120624940D1CD8E97E634184033885172216249408C580B4DE534184038EAFD2E226249408256D02DE4341840C6C3D5E022624940460FECD4E234184061C7FBC923624940087565E4E13418405AFCE77C24624940D1204FFDE034184080AFE03B25624940CFDDBE3BE03418409933B0EF256249400B32A100DD341840E27B565C29624940409CFD21D1341840F6292A792C62494050C8F6C6CE3418406837321E2D6249404212175CCC341840B6BE2BCF2D6249401370952CCA3418407F8D94762E624940D087226EC7341840C9B7D2522F6249403878BF6AC534184085636EFC2F624940A2F5CB5DC3341840EA2716B2306249403AC11487C1341840E931B65D316249407A874235C03418401345C8DF31624940A817DBBB3230184055883D3C266249404C76FC2926301840A388813524624940F55A3465183018404919063F22624940AE0988C80830184098F4314620624940C999B339F92F1840C5C95F881E624940BE566203E42F1840AB71966E1C624940C0205FE4D22F1840EDB5E7EF1A624940CC38A5F6BF2F1840B8EF087D1962494023372187AD2F184018F80C43186249405B73229EFE2D184049C52BA3FF614940ACF1F4B9E72D184082D5F390FE614940016B55D5CE2D18403A1F52A5FD614940D3A8C2F6B62D1840D7D1E9FCFC614940C3C80ABC972D184016FB8A69FC614940AD5AAF5C7F2D1840B0534C2EFC61494060B33167652D1840BEF1F529FC614940D3503A034D2D184078C80E5DFC6149409F2D5A7B9C2B1840D324B2C2036249407F6B21AD992B18404F51BACF03624940905E66B1962B1840804962DE03624940A3EE50FC942B184054D13AE7036249402F25AC988A2B18403F841ED6006249405BCB3878892B18400EACDF82006249406626543F882B184076F48F2A00624940A8390514872B18401DFDEAD7FF6149407B2D9E85852B18401ECA436CFF6149407231884F842B1840AF5D3E1AFF61494054CEB0FF822B1840175B42C3FE614940C303E9BE812B1840B518E271FE614940B10BD3A0802B18403D1CC82AFE614940EF6E6F557F2B1840B69712DAFD6149401B5E01EF7D2B184071228284FD614940BAA418997C2B1840A6E37C34FD614940A14D38D37A2B1840558352CCFC6149400BE7E172792B18406506037DFC614940E7693FF6772B18401493F528FC614940A07C938B762B1840AB4761DAFB614940CBC4C92C752B184069C1CA8FFB614940972BE1B7732B18401F0AF741FB6149408A9A7225722B184072A383EFFA61494076E466A6702B1840D7D575A2FA6149403AD0FEAA6E2B1840C2783A3EFA614940103EEA216D2B1840CCDCF7F1F9614940FCEA1D7A6B2B1840FE1C35A1F9614940D66D1BE7692B1840C0ECC255F96149406E553981682B1840E597EF13F9614940278C64E4662B184014FF52C9F861494001A4AE27652B1840B209577AF86149404ED92381632B18404C259530F861494061446052612B184016ACB6D0F7614940A86E3CA25F2B1840578AD487F761494040DA16D15D2B18405206B53AF7614940FF9777175C2B18400EA6B7F2F66149402A90380A6B2A184097D0FF4FD0614940A8010C505D2A18409EFB7C5DCE614940056EF9C14D2A1840306E9A68CC6149409FA8F6433E2A1840372438AECA614940CCCF7726292A184056366C98C86149404001941D182A18400DE8841CC76149406980AB49052A18405DC033ACC5614940D89F87F4F229184054283C74C4614940B9C0CF11B929184003DA6925C16149405E8D6F55B72918409F33630CC1614940E906277BB5291840886F11F2C061494091819ABCB32918402E6DA7D9C0614940F6CD4B73B1291840849E21BAC061494063C5A0B2AF291840760155A2C06149408C0CD5D3AD29184026635289C06149402D5D1911AC2918409CE72372C0614940C171816E0C2818407BD30567AB6149403BC316F004281840EF4E4A0CAB6149406CBEC7E4FC2718401D16A4B1AA614940E473DB46F5271840E0851762AA61494023CACA41EB271840606D9701AA614940B4608888E32718400C5E65BDA9614940B78A0B43DB27184075F0E87AA96149409676AD72D32718407DB73642A96149403671C7BF7B271840E1FDC609A76149407B09A5446D27184098302CC0A6614940E5AF39C65D271840D9B7CD86A6614940613394264F2718405D7EA464A661494094E92D123C2718405FBCFC51A661494002DFD4682D27184005B88357A66149409F83CAD51D271840EAA28172A6614940903B9F3D0F2718407BB1AE9FA66149403CF79280F52618401A00B512A7614940D65E6E89A2261840CA407A85A8614940D546AE0664261840592FD69CA9614940641C8BD91A261840AD27DCE3AA6149402A087ADBE325184007B89ED9AB614940BD3F45B4A6251840CC7BE9EAAC614940AEAB3F1AA1251840BE69F106AD614940E409C3279B25184076DCE627AD6149408555D895952518407962C849AD614940B63F73548E251840E564DD79AD6149402B4F2ACC8825184044398FA1AD61494078DC2EEE82251840FC04E5CEAD61494067ED0B717D25184018465CFCAD614940ACCC48A8782518401CA6AC26AE6149409811CD37732518403BDDDC59AE6149409752C1746D251840554F6193AE6149402D846A126825184034743CCCAE61494078861E13612518402232361AAF614940E97C66C05B251840C3AEAC58AF614940C86F9B1E56251840D6B9209EAF614940F8BCF7DC50251840A56E21E2AF614940B52D31C24B25184030C94C27B061494063B11293462518400212C570B0614940C9DFB418412518400693DCC1B06149400E6987FD3B251840DC4BB810B16149408ACEFA5E352518404538417BB1614940B1B32459302518400FC36ACFB1614940106F350C2B251840CDD4CC2BB2614940A42C171D26251840421F2D85B261494009A2ACD5212518405221ACD5B2614940877BA0FE1C2518402EAB2A34B36149400248EFE417251840AB07729BB36149405EE648271325184094E9F4FEB361494003347A060D251840B95E3A84B4614940784A8663082518403451A6ECB4614940F17EAA8203251840CCC0615EB56149401A6EAEFBFE241840DC239ACBB561494064A696431924184054059230CC61494002C00747F4221840C22F6F93C9614940438C289FE72218404A4973FEC76149408B96394DDC221840936A3594C6614940EB2F20E2B2221840BF3DD266C1614940656BF44CDF2018402EC52CF4866149408448F839DB201840ABF9FF7586614940807038D2D6201840A0E4F7F1856149402F71C49ED2201840A168207885614940AA24AC0CCD201840178ECBDB846149404819E7B9C820184023C86A66846149409D577C0FC4201840BE55E3EB83614940A4A6959EBF2018402673197B83614940EC1A7CAEBB201840A819681A83614940FA6CAB20B72018409E0554AE826149402E1DB338B2201840DD87D33D82614940C009388FAD20184031E392D681614940A8E41466A72018403CFCD85281614940CD9536A2A2201840CF1488F080614940278D11829D201840AFDF898A80614940E86A1EA59820184023A9432D806149400AE422D893201840BFF391D47F614940583670E38E201840DFFF6F7C7F61494066DFBC90892018403FE263217F6149401070A68584201840F2597ECE7E614940C4AC74E07D2018405964A0657E61494039695CC0782018401D010E187E6149406899F040732018400CCA57C87D61494058313E0D6E201840AECF2D807D614940072F497769201840893465437D614940D1B1693164201840566BB7007D614940C9444C8B5E201840BF7CAEBC7C61494057BCB13459201840082C8F7F7C6149406EFA8C3052201840467F58337C6149405C09AECA4C2018408B68D8FB7B614940C4461004472018407557C7C37B614940C9BC6790412018408CB1F5917B614940877A34E10F2018400483F2E7796149400348734E07201840F01BDFA5796149404A8DE420FE1F1840EE43FF6679614940D8D61576F51F18405F2FF73279614940615D1CFD3B1D1840442339216B61494019657768B91418404393E89D94624940F7CD24184D151840B01B6E83D962494054B3B26250151840270B9FDEDA624940C0B08243541518401D71364CDC624940DF7FEB4158151840C1B1C59FDD624940CB9290EA5D1518406B82F054DF624940AB7F739862151840E1D7699FE0624940422586EE67151840BCBCADF9E1624940B806C2466D1518405FE0A639E362494052347FC576151840031BEC47E5624940CD2338C27C1518401749067CE6624940A9BA2D76831518401CF409BDE76249404580D3108A151840466CF3E3E86249402A8C49119315184076DA5A5BEA62494067D09E429A151840FD51D073EB624940030C1B37A215184038A51596EC62494070483DF7A91518408BA9E39EED624940",
}


class E2WatchCrawler(BaseCrawler):
    def __init__(self, schema_name):
        super().__init__(schema_name)

    def create_table(self):
        try:
            query_create_hypertable = text(
                "SELECT public.create_hypertable('e2watch', 'timestamp', if_not_exists => TRUE, migrate_data => TRUE);"
            )
            with self.engine.begin() as conn:
                conn.execute(
                    text(
                        "CREATE TABLE IF NOT EXISTS e2watch( "
                        "timestamp timestamp without time zone NOT NULL, "
                        "bilanzkreis_id text, "
                        "strom_kwh double precision, "
                        "wasser_m3 double precision, "
                        "waerme_kwh double precision, "
                        "temperatur double precision, "
                        "PRIMARY KEY (timestamp , bilanzkreis_id));"
                    )
                )
                conn.execute(query_create_hypertable)
            log.info("created hypertable e2watch")
        except Exception as e:
            log.error(f"could not create hypertable: {e}")

        try:
            with self.engine.begin() as conn:
                conn.execute(
                    text(
                        "CREATE TABLE IF NOT EXISTS buildings( "
                        "bilanzkreis_id text, "
                        "building_id text, "
                        "lat double precision, "
                        "lon double precision, "
                        "beschreibung text, "
                        "strasse text, "
                        "plz text, "
                        "stadt text, "
                        "PRIMARY KEY (bilanzkreis_id));"
                    )
                )
            log.info("created table buildings")
        except Exception as e:
            log.error(f"could not create table: {e}")

    def get_all_buildings(self):
        sql = "select * from buildings"

        try:
            with self.engine.begin() as conn:
                building_data = pd.read_sql(sql, conn, parse_dates=["timestamp"])
            if len(building_data) > 0:
                log.info(
                    "Building data already exists in the database. No need to crawl it again."
                )
                building_data = building_data.set_index(["bilanzkreis_id"])
                return building_data
        except Exception as e:
            log.error(
                f"There does not exist a table buildings yet. The buildings will now be crawled. {e}"
            )

        df = pd.read_csv(
            os.path.realpath(
                os.path.join(
                    os.path.dirname(__file__),
                    "data",
                    "e2watch_building_data.csv",
                )
            )
        )
        df = df.set_index(["bilanzkreis_id"])
        return df

    def get_data_per_building(self, buildings: pd.DataFrame):
        energy = ["strom", "wasser", "waerme"]
        end_date = date.today().strftime("%d.%m.%Y")

        for bilanzkreis_id in buildings.index.values:
            df_last = pd.DataFrame([])
            for measurement in energy:
                start_date = self.select_latest(bilanzkreis_id) + timedelta(hours=1)
                if start_date.tzinfo is not None:
                    start_date_tz = start_date.tz_convert("Europe/Berlin")
                else:
                    start_date_tz = start_date.tz_localize("UTC").tz_convert(
                        "Europe/Berlin"
                    )
                start_date_str = start_date_tz.strftime("%d.%m.%Y %H:%M:%S")
                url = f"https://stadt-aachen.e2watch.de/gebaeude/getMainChartData/{bilanzkreis_id}?medium={measurement}&from={start_date_str}&to={end_date}&type=stundenverbrauch"
                log.info(url)
                response = requests.get(url)
                try:
                    response.raise_for_status()
                except requests.exceptions.HTTPError as e:
                    log.error(f"Could not get data for building: {bilanzkreis_id} {e}")
                    continue
                data = json.loads(response.text)
                timeseries = pd.DataFrame.from_dict(data["result"]["series"][0]["data"])
                if timeseries.empty:
                    log.info(f"Received empty data for building: {bilanzkreis_id}")
                    continue
                timeseries[0] = pd.to_datetime(timeseries[0], unit="ms", utc=True)
                timeseries.columns = [
                    "timestamp",
                    (
                        measurement + "_kwh"
                        if measurement in ("strom", "waerme")
                        else measurement + "_m3"
                    ),
                ]
                temperature = pd.DataFrame.from_dict(
                    data["result"]["series"][1]["data"]
                )
                if temperature.empty:
                    log.info(
                        f"Received empty temperature for building: {bilanzkreis_id}"
                    )
                    continue
                temperature[0] = pd.to_datetime(temperature[0], unit="ms", utc=True)
                temperature.columns = ["timestamp", "temperatur"]
                timeseries = pd.merge(timeseries, temperature, on=["timestamp"])

                if not df_last.empty:
                    df_last = pd.merge(
                        timeseries, df_last, on=["timestamp", "temperatur"]
                    )

                else:
                    df_last = timeseries

            if not df_last.empty:
                df_last.insert(0, "bilanzkreis_id", bilanzkreis_id)
            yield df_last

    def select_latest(self, bilanzkreis_id) -> pd.Timestamp:
        # day = default_start_date
        # today = date.today().strftime('%d.%m.%Y')
        # sql = f"select timestamp from e2watch where timestamp > '{day}' and timestamp < '{today}' order by timestamp desc limit 1"
        sql = f"select timestamp from e2watch where bilanzkreis_id='{bilanzkreis_id}' order by timestamp desc limit 1"
        try:
            with self.engine.begin() as conn:
                latest = pd.read_sql(sql, conn, parse_dates=["timestamp"]).values[0][0]
            latest = pd.to_datetime(latest, unit="ns")
            log.info(f"The latest date in the database is {latest}")
            return latest
        except Exception as e:
            log.info(f"Using the default start date {e}")
            return pd.to_datetime(default_start_date)

    def feed(self, buildings: pd.DataFrame):
        sql = "select * from buildings"
        try:
            with self.engine.begin() as conn:
                building_data = pd.read_sql(sql, conn, parse_dates=["timestamp"])
                if len(building_data) == 0:
                    log.info("creating new buildings table")
                    buildings.to_sql("buildings", con=conn, if_exists="append")
        except Exception as e:
            log.info(f"Probably no database connection: {e}")
        for data_for_building in self.get_data_per_building(buildings):
            if data_for_building.empty:
                continue
            df_for_building = data_for_building.set_index(
                ["timestamp", "bilanzkreis_id"]
            )
            # delete timezone duplicate
            # https://stackoverflow.com/a/34297689
            df_for_building = df_for_building[
                ~df_for_building.index.duplicated(keep="first")
            ]

            log.info(df_for_building)
            with self.engine.begin() as conn:
                df_for_building.to_sql("e2watch", con=conn, if_exists="append")


def main(schema_name):
    ec = E2WatchCrawler(schema_name)
    ec.create_table()
    buildings = ec.get_all_buildings()
    ec.feed(buildings)
    ec.set_metadata(metadata_info)


if __name__ == "__main__":
    logging.basicConfig(filename="e2watch.log", encoding="utf-8", level=logging.INFO)
    # db_uri = 'sqlite:///./data/e2watch.db'
    main("e2watch")
